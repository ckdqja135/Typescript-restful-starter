### 시작
메모리맵을 파일DB로 바꾸기 위한 전작업으로 리팩토링을 시작.

먼저 테스트 코드를 만들어보자!
<code>app/app_test.go</code>
``` Go

  package app

  import (
    "testing"

    "github.com/stretchr/testify/assert"

  )

  func TestTodos(t *testing.T) {
    assert := assert.New(t)
    ts := httptest.NewServer(MakeHandler())
	  defer ts.Close()
    
    resp, err := http.PostForm(ts.URL+"/todos", url.Values{"name": {"Test todo"}}) // 1
    assert.NoError(err) // 2
	  assert.Equal(http.StatusCreated, resp.StatusCode) // 3
  }
  
```
1 : Add를 한 다음에 GET을 해서 제대로 나오는지 해보기 위해 먼저 POST를 해준다. <br />
    URL, Value를 인자로 받는다. 이 때 응답과 에러가 나오는데<br />
2 : 에러가 없어야 하기 때문에 NoError로 해주고, <br />
3 : 응답의 코드가 같은지 확인해준다. <br />

그 후 <code>app/app.go</code>에서
``` Go

  func addTodoHandler(w http.ResponseWriter, r *http.Request) {
    name := r.FormValue("name")
    id := len(todoMap) + 1
    todo := &Todo{id, name, false, time.Now()}
    todoMap[id] = todo
    rd.JSON(w, http.StatusCreated, todo)
  }


/*
func addTestTodos() {
	todoMap[1] = &Todo{1, "Buy a milk", false, time.Now()}
	todoMap[2] = &Todo{2, "Exercise", true, time.Now()}
	todoMap[3] = &Todo{3, "Home work", false, time.Now()}
}
*/
func MakeHandler() http.Handler {
	todoMap = make(map[int]*Todo)
	// addTestTodos()

	rd = render.New()
	r := mux.NewRouter()

	r.HandleFunc("/todos", getTodoListHandler).Methods("GET")
	r.HandleFunc("/todos", addTodoHandler).Methods("POST")
	r.HandleFunc("/todos/{id:[0-9]+}", removeTodoHandler).Methods("DELETE")
	r.HandleFunc("/complete-todo/{id:[0-9]+}", completeTodoHandler).Methods("GET")
	r.HandleFunc("/", indexHandler)

	return r
}

```
rd.JSON(w, http.StatusCreated, todo)로 변경해주고, addTestTodos와 addTestTodos()는 지워준다. <br />

여기서 저장 후 테스트를 진행해보면 <br />
<p align = "center"> <img src = "https://user-images.githubusercontent.com/33046341/94105182-b46da480-fe73-11ea-9ea0-fae23211d042.png" width = 70%> </img></p> 
PASS 되는 것을 확인 할 수 있다. <br />

그리고 이어서 상대방이 JSON포맷으로 새로 만든 todo를 보내주기 때문에 이것을 읽어주는 코드를 작성하자 ! <br />
<code>app/app_test.go</code>
``` Go

  package app

  import (
    "testing"

    "github.com/stretchr/testify/assert"

  )

  func TestTodos(t *testing.T) {
    assert := assert.New(t)
    ts := httptest.NewServer(MakeHandler())
	  defer ts.Close()
    
    resp, err := http.PostForm(ts.URL+"/todos", url.Values{"name": {"Test todo"}})
    assert.NoError(err)
	  assert.Equal(http.StatusCreated, resp.StatusCode) 
    var todo model.Todo // 1
    err = json.NewDecoder(resp.Body).Decode(&todo) // 2
    assert.NoError(err)
    assert.Equal(todo.Name, "Test todo") // 3
  }
  
```
1 : Decode해줄 todo객체 <br />
2 : 새로만든 todo객체를 읽어오는 코드 <br />
3 : todo객체의 name이 보낸 name과 같은지 확인한다. <br />

여기까지 해서 다시 테스트하면
<p align = "center"> <img src = "https://user-images.githubusercontent.com/33046341/94105182-b46da480-fe73-11ea-9ea0-fae23211d042.png" width = 70%> </img></p> 
PASS 되는 것을 확인 할 수 있다. <br />

그러면 이 서버가 추가한 todo의 id가 나오는데 그 id를 먼저 저장 해준다. <br />

<code>app/app_test.go</code>
``` Go

  package app

  import (
    "testing"

    "github.com/stretchr/testify/assert"

  )

  func TestTodos(t *testing.T) {
    assert := assert.New(t)
    ts := httptest.NewServer(MakeHandler())
	  defer ts.Close()
    
    resp, err := http.PostForm(ts.URL+"/todos", url.Values{"name": {"Test todo"}})
    assert.NoError(err)
	  assert.Equal(http.StatusCreated, resp.StatusCode) 
    var todo model.Todo 
    err = json.NewDecoder(resp.Body).Decode(&todo)
    assert.NoError(err)
    assert.Equal(todo.Name, "Test todo") 
    id1 := todo.ID // 1
  }
  
```

1 : todo의 id <br />
그 후 <br />

``` Go 

    resp, err := http.PostForm(ts.URL+"/todos", url.Values{"name": {"Test todo"}})
    assert.NoError(err)
	  assert.Equal(http.StatusCreated, resp.StatusCode) 
    var todo Todo 
    err = json.NewDecoder(resp.Body).Decode(&todo)
    assert.NoError(err)
    assert.Equal(todo.Name, "Test todo") 
    
```

부분을 아래에 복붙하여 작성한다. <br />

``` Go

  package app

  import (
    "testing"

    "github.com/stretchr/testify/assert"

  )

  func TestTodos(t *testing.T) {
    assert := assert.New(t)
    ts := httptest.NewServer(MakeHandler())
	  defer ts.Close()
    
    resp, err := http.PostForm(ts.URL+"/todos", url.Values{"name": {"Test todo"}})
    assert.NoError(err)
	  assert.Equal(http.StatusCreated, resp.StatusCode) 
    var todo Todo 
    err = json.NewDecoder(resp.Body).Decode(&todo)
    assert.NoError(err)
    assert.Equal(todo.Name, "Test todo") 
    
    id1 := todo.ID
    resp, err = http.PostForm(ts.URL+"/todos", url.Values{"name": {"Test todo2"}})
    assert.NoError(err)
    assert.Equal(http.StatusCreated, resp.StatusCode)
    err = json.NewDecoder(resp.Body).Decode(&todo)
    assert.NoError(err)
    assert.Equal(todo.Name, "Test todo2")
    id2 := todo.ID
    
    resp, err = http.Get(ts.URL + "/todos")
    assert.NoError(err)
    assert.Equal(http.StatusOK, resp.StatusCode)
    todos := []*model.Todo{} // 1
    err = json.NewDecoder(resp.Body).Decode(&todos) // 2
    assert.NoError(err)
    assert.Equal(len(todos), 2) // 3
    for _, t := range todos { // 4
      if t.ID == id1 {
        assert.Equal("Test todo", t.Name)
      } else if t.ID == id2 {
        assert.Equal("Test todo2", t.Name)
      } else {
        assert.Error(fmt.Errorf("testID should be id1 or id2"))
      }
    }
  }
  
```


1,2 : getTodoListHandler()에서 list를 JSON으로 보내기 때문에 JSON으로 todo list를 받아온다. <br />
3 : todos의 길이가 2개인지 확인한다. <br />
4 : 검증 부분. 
    t의 id가 첫번째 추가한 id1과 같다면 첫번째 값인 "test todo"이 되야 하고, <br />
    t의 id가 두번째 추가한 id2와 같다면 "Test todo2"가 되어야 한다. <br />
    1번과도 같지않고, 2번과도 같지않다면 문제가 있으므로 에러처리를 해준다. <br />
    list를 range로 돌 때 첫번째 인자가 index, value가 나오는데 index를 쓰지 않기 때문에 _처리 해준다. <br />
    
2개를 POST해주었기 때문에 GET을 해주면 2개가 와야한다. <br />

이렇게 해서 테스트 해보자! <br />
<p align = "center"> <img src = "https://user-images.githubusercontent.com/33046341/94105182-b46da480-fe73-11ea-9ea0-fae23211d042.png" width = 70%> </img></p> 
PASS 되는 것을 확인 할 수 있다. <br />

GET과 POST가 되는것을 확인했고, 이제 Complete를 해보자! <br />
Complete를 보낼 때 URL에 id를 붙여서 보냈고, 그 다음에 FormValue로 "complete"를 보냈고, 메소드는 GET으로 보냈었다. <br />

``` Go

  package app

  import (
    "testing"

    "github.com/stretchr/testify/assert"

  )

  func TestTodos(t *testing.T) {
   
   ....
    
    resp, err = http.Get(ts.URL + "/todos")
    assert.NoError(err)
    assert.Equal(http.StatusOK, resp.StatusCode)
    todos := []*model.Todo{} 
    err = json.NewDecoder(resp.Body).Decode(&todos) 
    assert.NoError(err)
    assert.Equal(len(todos), 2) 
    for _, t := range todos {
      if t.ID == id1 {
        assert.Equal("Test todo", t.Name)
      } else if t.ID == id2 {
        assert.Equal("Test todo2", t.Name)
      } else {
        assert.Error(fmt.Errorf("testID should be id1 or id2"))
      }
    }
    
   resp, err = http.Get(ts.URL + "/complete-todo/" + strconv.Itoa(id1) + "?complete=true") // 1
   assert.NoError(err)
   assert.Equal(http.StatusOK, resp.StatusCode)
   
   resp, err = http.Get(ts.URL + "/todos") // 2
	 assert.NoError(err)
	 assert.Equal(http.StatusOK, resp.StatusCode)
	 todos = []*model.Todo{}
	 err = json.NewDecoder(resp.Body).Decode(&todos)
 	 assert.NoError(err) 
	 assert.Equal(len(todos), 2)
	 for _, t := range todos {
	 	 if t.ID == id1 {
			 assert.True(t.Completed)
		 }
	 }
  }
  
```
1 : GET으로 보내주기 위해 사용 <br />
    id1을 complete값을 true로 바꾸어준다. <br />
    
2 : 실제로 Complete가 바뀌었는지 확인해주기 위해 GET을 다시해서 검증해준다. <br />
    현재는 바꾼 id1만 검증하기 때문에 id1에 대해서만 작성한다. <br />

그래서 complte-todo를 한 다음에 GET으로 list를 다시 가져와서 가져온 id가 id1과 같을 때 Completed가 true로 바뀌어야 한다. <br />

이 상태에서 다시 테스트를 해보면 <br />
<p align = "center"> <img src = "https://user-images.githubusercontent.com/33046341/94105182-b46da480-fe73-11ea-9ea0-fae23211d042.png" width = 70%> </img></p> 
PASS 되는 것을 확인 할 수 있다. <br />

이제 DELETE 하나 남았는데 저번 RESTful API를 했을 때 말했다시피 Golang 자체가 GET과 POST는 기본제공 하지만 DELETE는 제공하지 않기 때문에 Request를 새로 만들어 주어야 한다. <br />
``` Go

  package app

  import (
    "testing"

    "github.com/stretchr/testify/assert"

  )

  func TestTodos(t *testing.T) {
   
   ....
   
	 for _, t := range todos {
	 	 if t.ID == id1 {
			 assert.True(t.Completed)
		 }
	 }
   
   req, _ := http.NewRequest("DELETE", ts.URL+"/todos/"+strconv.Itoa(id1), nil) // 1
   
  }
  
```

1 : 그래서 사용하는게 NewRequest()인데 첫번째 값이 메소드, 두번째 값이 URL을 넣어주고, id를 넣어준 다음 data를 넣어야 하는데 data는 지금 필요없으니까 nil로 바꾸어준다. <br />
